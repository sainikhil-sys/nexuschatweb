{% extends 'base.html' %}
{% block title %}Nearby Devices - Nexus Chat Web{% endblock %}
{% block body %}
<div class="nearby-page">
    <div class="nearby-header">
        <a href="/chat/" class="icon-btn"><span class="material-icons-round">arrow_back</span></a>
        <h2>Nearby Devices</h2>
        <button class="btn btn-primary btn-sm" id="scanBtn" onclick="startScan()">
            <span class="material-icons-round">radar</span> Scan
        </button>
    </div>

    <div class="nearby-info">
        <div class="radar-animation" id="radarAnimation">
            <div class="radar-circle"></div>
            <div class="radar-circle delay-1"></div>
            <div class="radar-circle delay-2"></div>
            <span class="material-icons-round radar-icon">wifi_tethering</span>
        </div>
        <p>Discover people on the same network</p>
        <p class="nearby-note">Both devices must be on the same Wi-Fi network</p>
    </div>

    <div class="nearby-devices-list" id="deviceList">
        <div class="empty-state">
            <span class="material-icons-round">devices</span>
            <p>No devices found yet. Click Scan to start.</p>
        </div>
    </div>
</div>

<script>
    let scanning = false;

    function startScan() {
        const btn = document.getElementById('scanBtn');
        const list = document.getElementById('deviceList');
        const radar = document.getElementById('radarAnimation');

        if (scanning) return;
        scanning = true;
        btn.disabled = true;
        btn.innerHTML = '<span class="material-icons-round spin">radar</span> Scanning...';
        radar.classList.add('active');

        // Poll the nearby devices API
        fetch('/api/nearby/')
            .then(r => r.json())
            .then(data => {
                list.innerHTML = '';
                if (data.devices && data.devices.length > 0) {
                    data.devices.forEach(device => {
                        list.innerHTML += `
                        <div class="nearby-device-card">
                            <img src="${device.avatar || '/static/img/default-avatar.svg'}" class="nearby-avatar" alt="">
                            <div class="nearby-device-info">
                                <h4>${device.username}</h4>
                                <span class="nearby-ip">${device.ip}</span>
                            </div>
                            <a href="/chat/start/${device.user_id}/" class="btn btn-primary btn-sm">
                                <span class="material-icons-round">chat</span> Chat
                            </a>
                        </div>
                    `;
                    });
                } else {
                    list.innerHTML = '<div class="empty-state"><span class="material-icons-round">devices</span><p>No nearby devices found. Make sure others are on the same network.</p></div>';
                }
            })
            .catch(() => {
                list.innerHTML = '<div class="empty-state"><span class="material-icons-round">wifi_off</span><p>Network scan failed. Check your connection.</p></div>';
            })
            .finally(() => {
                scanning = false;
                btn.disabled = false;
                btn.innerHTML = '<span class="material-icons-round">radar</span> Scan';
                setTimeout(() => radar.classList.remove('active'), 500);
            });
    }
</script>
{% endblock %}